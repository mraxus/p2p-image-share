<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>P2P Image Share</title>
    <style>
        body { font-family: sans-serif; padding: 1rem; }
        textarea { width: 100%; height: 60px; }
        img { max-width: 100%; margin-top: 1rem; }
    </style>
</head>
<body>
<h1>P2P Image Share (WebRTC + WebSocket)</h1>

<label>Peer ID to connect to:</label>
<input type="text" id="remoteId">
<button id="connect">Connect</button><br><br>

<input type="file" id="fileInput">
<button id="sendFile">Send Image</button><br>

<h3>Your ID: <span id="myId">...</span></h3>
<h3>Received Image:</h3>
<img id="receivedImage" alt="No image received yet.">

<script>
    const ws = new WebSocket(`ws://${location.host}`);
    const pc = new RTCPeerConnection();
    let dataChannel, remoteId;

    const $ = (id) => document.getElementById(id);

    ws.onmessage = async ({ data }) => {
        const msg = JSON.parse(data);
        if (msg.type === 'init') {
            $('myId').textContent = msg.id;
        }

        if (msg.type === 'offer') {
            await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({ to: msg.from, type: 'answer', answer }));
        }

        if (msg.type === 'answer') {
            await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
        }

        if (msg.type === 'candidate') {
            try {
                await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
            } catch (e) {
                console.error('Error adding ICE candidate', e);
            }
        }
    };

    pc.onicecandidate = ({ candidate }) => {
        if (candidate && remoteId) {
            ws.send(JSON.stringify({ to: remoteId, type: 'candidate', candidate }));
        }
    };

    pc.ondatachannel = (e) => {
        const channel = e.channel;
        channel.onmessage = (event) => {
            const blob = new Blob([event.data]);
            $('receivedImage').src = URL.createObjectURL(blob);
        };
    };

    $('connect').onclick = async () => {
        remoteId = $('remoteId').value;
        dataChannel = pc.createDataChannel("file");

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ to: remoteId, type: 'offer', offer }));

        dataChannel.onopen = () => {
            console.log("DataChannel opened");
        };
    };

    $('sendFile').onclick = () => {
        const file = $('fileInput').files[0];
        if (!file || !dataChannel || dataChannel.readyState !== "open") {
            alert("Select a file and ensure connection is ready");
            return;
        }
        const reader = new FileReader();
        reader.onload = () => dataChannel.send(reader.result);
        reader.readAsArrayBuffer(file);
    };
</script>
</body>
</html>
