<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>P2P Image Share (No Server)</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    textarea { width: 100%; height: 100px; margin: 0.5rem 0; }
    img { max-width: 100%; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>WebRTC Image Transfer (Peer-to-Peer)</h1>

  <input type="file" id="imageInput"><br>
  <button id="createOffer">1. Create Offer (Sender)</button><br>
  <textarea id="offerText" placeholder="Offer will appear here..."></textarea>

  <button id="acceptOffer">2. Accept Offer (Receiver)</button><br>
  <textarea id="answerText" placeholder="Answer will appear here (send back)..."></textarea>

  <button id="finalize">3. Finalize Connection (Sender)</button><br>

  <h3>Received Image:</h3>
  <img id="receivedImage" alt="No image received yet.">

  <script>
    let pc = new RTCPeerConnection();
    let dataChannel;

    const offerText = document.getElementById('offerText');
    const answerText = document.getElementById('answerText');
    const imageInput = document.getElementById('imageInput');
    const receivedImage = document.getElementById('receivedImage');

    document.getElementById('createOffer').onclick = async () => {
      dataChannel = pc.createDataChannel("img");

      dataChannel.onopen = () => {
        console.log("Data channel open");
        const file = imageInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = () => {
            dataChannel.send(reader.result);
            alert("Image sent!");
          };
          reader.readAsArrayBuffer(file);
        } else {
          alert("Please select an image first.");
        }
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      pc.onicecandidate = e => {
        if (!e.candidate) {
          offerText.value = btoa(JSON.stringify(pc.localDescription));
        }
      };
    };

    document.getElementById('acceptOffer').onclick = async () => {
      const offer = JSON.parse(atob(offerText.value));
      await pc.setRemoteDescription(offer);

      pc.ondatachannel = e => {
        e.channel.onmessage = msg => {
          const blob = new Blob([msg.data]);
          receivedImage.src = URL.createObjectURL(blob);
        };
      };

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      pc.onicecandidate = e => {
        if (!e.candidate) {
          answerText.value = btoa(JSON.stringify(pc.localDescription));
        }
      };
    };

    document.getElementById('finalize').onclick = async () => {
      const answer = JSON.parse(atob(answerText.value));
      await pc.setRemoteDescription(answer);
    };
  </script>
</body>
</html>

