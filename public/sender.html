<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sender - P2P Image Share</title>
    <style>
        body { font-family: sans-serif; padding: 1rem; }
        input, button { margin: 0.5rem 0; }
    </style>
</head>
<body>
<h1>Sender</h1>
<p>Your ID: <span id="myId">...</span></p>

<input type="text" id="remoteId" placeholder="Receiver ID">
<button id="connect">Connect</button><br>

<input type="file" id="fileInput">
<button id="sendFile">Send Image</button><br>

<script>
    const ws = new WebSocket(`ws://${location.host}`);
    const pc = new RTCPeerConnection();
    const CHUNK_SIZE = 16 * 1024;
    let dataChannel, remoteId;

    const $ = id => document.getElementById(id);

    ws.onmessage = async ({ data }) => {
        const msg = JSON.parse(data);
        if (msg.type === 'init') {
            $('myId').textContent = msg.id;
        }

        if (msg.type === 'answer') {
            await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
        }

        if (msg.type === 'candidate') {
            try {
                await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
            } catch (e) {
                console.error('Error adding ICE candidate', e);
            }
        }
    };

    pc.onicecandidate = ({ candidate }) => {
        if (candidate && remoteId) {
            ws.send(JSON.stringify({ to: remoteId, type: 'candidate', candidate }));
        }
    };

    $('connect').onclick = async () => {
        remoteId = $('remoteId').value;
        dataChannel = pc.createDataChannel("file");
        dataChannel.binaryType = 'arraybuffer';

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ to: remoteId, type: 'offer', offer }));

        dataChannel.onopen = () => console.log("DataChannel opened");
    };

    $('sendFile').onclick = () => {
        const file = $('fileInput').files[0];
        if (!file || !dataChannel || dataChannel.readyState !== "open") {
            alert("Select a file and ensure connection is ready");
            return;
        }

        const header = JSON.stringify({ name: file.name, size: file.size });
        dataChannel.send(header);

        const reader = new FileReader();
        let offset = 0;

        const readSlice = o => {
            const slice = file.slice(o, o + CHUNK_SIZE);
            reader.readAsArrayBuffer(slice);
        };

        reader.onload = e => {
            dataChannel.send(e.target.result);
            offset += e.target.result.byteLength;

            if (offset < file.size) {
                setTimeout(() => readSlice(offset), 0);
            } else {
                console.log("File sent completely");
            }
        };

        readSlice(0);
    };
</script>
</body>
</html>
